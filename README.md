# Registry with Letsencrypt Certificates

This service stack issues [letsencrypt](https://letsencrypt.org/) certificates and starts a docker image registry
with a web frontend. The certificates are renewed automatically in case they expire. To start the service stack run the following command:  

`./startregistry.sh example.com`

To stop the service stack run 

`./stopregistry.sh`

## Services
### Certbot

The certbot image is a wrapper of the official [certbot/certbot](https://hub.docker.com/r/certbot/certbot/)
image which can issue certificates from letsencrypt. The wrapper add the 
functionality that certificates are renewed in case they are expired.
 
For more information read the [certbot README](/certbot/README.md).

### Registry

#### Configuration

##### Ports

The registry image exposes the port **5000**. You can map this port to another on the host machine.  

##### Environment variables

- **REGISTRY_HTTP_TLS_CERTIFICATE:** The path to the certificate file (generated by the certbot container) 
- **REGISTRY_HTTP_TLS_KEY:** The path to the private key file (generated by the certbot container)
- **REGISTRY_AUTH:** The registry authentication methods. Possible authentication providers are *silly, token* and *htpasswd* 
- **REGISTRY_AUTH_HTPASSWD_REALM:** The realm in which the registry server authenticates.
- **REGISTRY_AUTH_HTPASSWD_PATH:** The path to the `htpasswd` file to load at startup.
- **FORCE_SSL:** Whether to use SSL encrytion or not. 

##### Volumes

Mount the following volumes.

    volumes:
      - ./registry:/var/lib/registry
      - ./certs:/certs
      - ./auth:/auth

The *registry* volume stores the data pushed to the registry. The *certs* volume stores your certificates and the *auth* volume contains the htpasswd file for authentication.

### Registry frontend

The registry frontend is implemented in the image [docker-registry-frontend](https://github.com/kwk/docker-registry-frontend) maintained by Konrad Kleine.

The image is ***not*** part of the docker-compose file, because it is necessary that certain conditions are fullfilled 
before starting this image. Especially it is really necessary, that the certificates are valid and present.
This means, that you start only the letsencrypt certificate automation and the docker registry with `docker-compose up`.
The registry frontend will only start properly with this command:
 
`docker run -d -e ENV_DOCKER_REGISTRY_HOST=$1 -e ENV_DOCKER_REGISTRY_PORT=5000 \
     -e ENV_USE_SSL=yes -e ENV_DOCKER_REGISTRY_USE_SSL=1 -v $PWD/certs/example.com.key.pem:/etc/apache2/server.key:ro \
     -v $PWD/certs/example.com.fullchain.pem:/etc/apache2/server.crt:ro --restart always -p 443:443 \
     konradkleine/docker-registry-frontend:v2`   

#### Configuration
 
##### Ports
The image exposes port 443
 
##### Environment variables
- **ENV_DOCKER_REGISTRY_HOST:** The host / container where the registry is running
- **ENV_DOCKER_REGISTRY_PORT:** The port on which the registry is running
- **ENV_USE_SSL:** Whether to use ssl or not 
- **ENV_DOCKER_REGISTRY_USE_SSL:** Whether the registry uses ssl or not

##### Volumes
In case you want an encrypted frontend it is necessary to mount your 
certificates to `/etc/apache2/server.key` and `/etc/apache2/server.crt`

Example: `$docker run ... -v $PWD/certs/dh-2.docklab.de.fullchain.pem:/etc/apache2/server.crt:ro ...`